name: Build and Deploy Mobile Apps

on:
    # DÃ©clenchement manuel
    workflow_dispatch:
        inputs:
            deploy_android:
                description: "Deploy Android"
                required: false
                default: true
                type: boolean
            deploy_ios:
                description: "Deploy iOS"
                required: false
                default: true
                type: boolean
            android_track:
                description: "Android Track (internal, beta, or production)"
                required: false
                default: "internal"
                type: choice
                options:
                    - internal
                    - beta
                    - production
            ios_upload_testflight:
                description: "Upload iOS to TestFlight"
                required: false
                default: true
                type: boolean
    # DÃ©clenchement automatique sur push
    push:
        branches:
            - main
            - fastlane
        paths:
            - "src/**"
            - "android/**"
            - "ios/**"
            - "capacitor.config.ts"
            - "package.json"
            - ".github/workflows/build-and-deploy.yml"

jobs:
    # Job 1 : Build du web app (une seule fois)
    build-web:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build web app
              env:
                  VITE_PROTOCOL_API_URL: https://api.usegossip.com/
              run: npm run build

            - name: Upload web build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: web-build-${{ github.sha }}
                  path: dist/
                  retention-days: 1

    # Job 2 : Build et deploy Android
    build-android:
        needs: build-web
        if: (github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_android == 'true')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download web build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: web-build-${{ github.sha }}
                  path: dist/

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Install dependencies (for Capacitor CLI)
              run: npm ci

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "21"
                  cache: "gradle"

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: "3.3.10"
                  bundler-cache: true
                  working-directory: android

            - name: Sync Capacitor Android
              run: npm run cap:sync:android

            - name: Display deployment info
              run: |
                  if [ "${{ github.event_name }}" == "push" ]; then
                    echo "ðŸš€ Automatic Android deployment triggered by push to ${{ github.ref_name }}"
                    echo "ðŸ“± Target: Google Play Internal Testing"
                  else
                    echo "ðŸŽ¯ Manual Android deployment triggered"
                    echo "ðŸ“± Target: Google Play ${{ github.event.inputs.android_track }} track"
                  fi

            - name: Create keystore from secrets
              run: |
                  echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ${{ github.workspace }}/android/app/keystore.jks
                  echo "ANDROID_KEYSTORE_FILE=${{ github.workspace }}/android/app/keystore.jks" >> $GITHUB_ENV

            - name: Build and Upload to Google Play
              env:
                  ANDROID_KEYSTORE_FILE: ${{ env.ANDROID_KEYSTORE_FILE }}
                  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
                  ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
                  ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
                  PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
              working-directory: android
              run: |
                  if [ "${{ github.event_name }}" == "push" ]; then
                    bundle exec fastlane beta
                  elif [ "${{ github.event.inputs.android_track }}" == "internal" ]; then
                    bundle exec fastlane beta
                  elif [ "${{ github.event.inputs.android_track }}" == "beta" ]; then
                    bundle exec fastlane beta_public
                  elif [ "${{ github.event.inputs.android_track }}" == "production" ]; then
                    bundle exec fastlane production
                  fi

            - name: Upload AAB artifact
              if: success()
              uses: actions/upload-artifact@v4
              with:
                  name: android-app-${{ github.event_name == 'push' && 'internal' || github.event.inputs.android_track }}-${{ github.run_number }}
                  path: android/app/build/outputs/bundle/release/*.aab
                  if-no-files-found: error
                  retention-days: 30

            - name: Cleanup keystore
              if: always()
              run: rm -f ${{ github.workspace }}/android/app/keystore.jks

    # Job 3 : Build et deploy iOS
    build-ios:
        needs: build-web
        if: (github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_ios == 'true')
        runs-on: macos-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download web build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: web-build-${{ github.sha }}
                  path: dist/

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Install dependencies (for Capacitor CLI)
              run: npm ci

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: "3.3.10"
                  bundler-cache: true
                  working-directory: ios/App

            - name: Install CocoaPods dependencies
              working-directory: ios/App
              run: pod install

            - name: Sync Capacitor iOS
              run: npm run cap:sync:ios

            - name: Configure Git for Match
              run: |
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git config --global user.name "GitHub Actions Bot"

            - name: Display deployment info
              run: |
                  if [ "${{ github.event_name }}" == "push" ]; then
                    echo "ðŸš€ Automatic iOS deployment triggered by push to ${{ github.ref_name }}"
                    echo "ðŸ“± Target: TestFlight"
                  else
                    echo "ðŸŽ¯ Manual iOS deployment triggered"
                    if [ "${{ github.event.inputs.ios_upload_testflight }}" == "true" ]; then
                      echo "ðŸ“± Target: TestFlight"
                    else
                      echo "ðŸ“± Build only (no upload)"
                    fi
                  fi

            - name: Build and Upload to TestFlight
              if: (github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.ios_upload_testflight == 'true')
              env:
                  APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
                  APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
                  APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
                  MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
                  MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
                  FASTLANE_SKIP_WAITING_FOR_BUILD_PROCESSING: "true"
              working-directory: ios/App
              run: bundle exec fastlane beta

            - name: Build Only (No Upload)
              if: github.event_name == 'workflow_dispatch' && github.event.inputs.ios_upload_testflight != 'true'
              env:
                  APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
                  APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
                  APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
                  MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
                  MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
              working-directory: ios/App
              run: bundle exec fastlane build

            - name: Upload IPA artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ios-app-${{ github.run_number }}
                  path: ios/App/*.ipa
                  if-no-files-found: warn
                  retention-days: 7
